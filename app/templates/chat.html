<!-- app/templates/chat.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Chat scam demo</title>
  <style>
    body{font-family:system-ui;margin:20px}
    .wrap{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .pane{border:1px solid #ddd;border-radius:8px;padding:10px;height:60vh;overflow:auto}
    .me{color:#0a7}
    .other{color:#06c}
    .bar{margin-top:12px;display:flex;gap:8px}
    input[type=text]{flex:1;padding:8px}
    small{opacity:.7}
  </style>
</head>
<body>
  <h3>Demo chat cu roluri (<span id="role"></span>) <small id="room"></small></h3>

  <div class="wrap">
    <div>
      <h4>Mesaje</h4>
      <div id="msgs" class="pane"></div>
      <div class="bar">
        <input id="inp" type="text" placeholder="scrie mesajul..." />
        <button id="send">Trimite</button>
      </div>
      <div class="bar">
        <button id="micStart">üéôÔ∏è Start voce</button>
        <button id="micStop">‚èπÔ∏è Stop</button>
      </div>
    </div>
    <div>
      <h4>Detec»õie ‚Äúscam‚Äù (simple keywords)</h4>
      <div id="alerts" class="pane"></div>
    </div>
  </div>

<script>
  // --- util: query params
  const params = new URLSearchParams(location.search);
  const room = params.get('room') || 'demo';
  const role = params.get('role') || 'victim';
  document.getElementById('role').textContent = role;
  document.getElementById('room').textContent = `(room: ${room})`;

  // --- websocket
  const wsProto = location.protocol === 'https:' ? 'wss' : 'ws';
  const ws = new WebSocket(`${wsProto}://${location.host}/ws/chat?room=${room}&role=${role}`);

  const msgs = document.getElementById('msgs');
  const alerts = document.getElementById('alerts');
  function addMsg(who, text) {
    const el = document.createElement('div');
    el.innerHTML = `<b class="${who===role?'me':'other'}">${who}:</b> ${text}`;
    msgs.appendChild(el); msgs.scrollTop = msgs.scrollHeight;
    checkScam(who, text);
  }
  function checkScam(who, text){
    const bad = /(transfer|urgent|cod|otp|parola|card|iban|paypal|crypto|tax|fine)/i;
    if (bad.test(text)){
      const el = document.createElement('div');
      el.innerHTML = `‚ö†Ô∏è <b>${who}</b>: <i>${text}</i>`;
      alerts.appendChild(el); alerts.scrollTop = alerts.scrollHeight;
    }
  }

  ws.onmessage = (e) => {
    const {role: who, text} = JSON.parse(e.data);
    addMsg(who, text);
  };

  // --- text input
  const inp = document.getElementById('inp');
  document.getElementById('send').onclick = () => {
    const text = inp.value.trim(); if(!text) return;
    ws.readyState===1 && ws.send(JSON.stringify({ text }));
    inp.value = '';
  };
  inp.addEventListener('keydown', e => { if(e.key==='Enter') document.getElementById('send').click(); });

  // --- microfon (op»õional, ca √Æn demo-ul tƒÉu)
  let rec;
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (SpeechRecognition){
    rec = new SpeechRecognition(); rec.lang='ro-RO'; rec.continuous=true; rec.interimResults=true;
    rec.onresult = (e) => {
      let t = '';
      for (let i=e.resultIndex; i<e.results.length; i++) t += e.results[i][0].transcript;
      // trimitem doar c√¢nd e final (nu interim) ca sƒÉ nu spamƒÉm
      if (!e.results[e.results.length-1].isFinal) return;
      ws.readyState===1 && ws.send(JSON.stringify({ text: t.trim() }));
    }
  }
  document.getElementById('micStart').onclick = ()=> rec && rec.start();
  document.getElementById('micStop').onclick  = ()=> rec && rec.stop();
</script>
</body>
</html>
